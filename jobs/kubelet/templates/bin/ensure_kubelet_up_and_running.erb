#!/bin/bash -e

[ -z "$DEBUG" ] || set -x

kubectl="/var/vcap/packages/kubernetes/bin/kubectl --kubeconfig=/var/vcap/jobs/kubeconfig/config/kubeconfig"

node_name="<%= spec.ip %>"
if [ "<%= p("cloud-provider.type") %>" == "gce" ]
then
  node_name="$(curl http://metadata.google.internal/computeMetadata/v1/instance/name -H "Bearer: $(curl "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" -H "Metadata-Flavor: Google" | jq '.access_token')" -H "Metadata-Flavor: Google").c.<%= p("cloud-provider.gce.project-id") %>.internal"
fi

# Wait for kubelet to become Ready before we move on to the next node.
# Scheduling might not be enabled at this time.
# The node then will be Ready;SchedulingDisabled
until ${kubectl} get nodes ${node_name} | grep -e ' Ready'; do
  sleep 2
done
